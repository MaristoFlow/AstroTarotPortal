<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Starborn Astrology & Tarot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0c0e12; --text:#e9eef7; --muted:#aab3c2; --card:#141824; --line:#22283a;
      --astro1:#1d2573; --astro2:#252f90; --tarot1:#3aa6e0; --tarot2:#6ec7ff;
      --accent:#7aa2ff; --accent-2:#9fd3ff; --shadow:rgba(0,0,0,.35);
      --button:#1f2840; --button-text:#e9eef7; --focus: 0 0 0 3px rgba(122,162,255,.4);
      --good:#7dffbc; --warn:#ffd27a; --bad:#ff9aa2; --infoBG: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
    }
    body[data-theme="light"]{
      --bg:#f7f9fc; --text:#0f1320; --muted:#596174; --card:#ffffff; --line:#e3e8f1;
      --astro1:#4052d1; --astro2:#6a7bf0; --tarot1:#6ec7ff; --tarot2:#9ee0ff;
      --accent:#3b63ff; --accent-2:#0876bf; --button:#e8eefb; --button-text:#0f1320;
      --shadow:rgba(0,0,0,.08); --focus: 0 0 0 3px rgba(59,99,255,.3);
      --infoBG: linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,0));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit}
    .wrap{min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto}
    :is(button,a,input,select,[tabindex]):focus{outline:none; box-shadow:var(--focus)}
    .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

    header{position:sticky; top:0; z-index:50; background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,0)); backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--line)}
    .head-inner{max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
    .brand-badge{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 200deg,var(--astro1),var(--astro2),var(--tarot1),var(--tarot2),var(--astro1));box-shadow:0 6px 14px var(--shadow), inset 0 0 0 1px rgba(255,255,255,.15);flex:0 0 28px}
    .toggle{display:flex; gap:8px; align-items:center; background:var(--button); color:var(--button-text); border:1px solid var(--line); border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:700}
    .toggle span{opacity:.8}
    .hint{font-size:.9rem; color:var(--muted)}
    .spacer{flex:1}

    .main{max-width:1200px; margin:16px auto; padding:16px; display:grid; gap:16px; grid-template-columns:1fr 1fr}
    .panel{border:1px solid var(--line); border-radius:16px; overflow:hidden; background:var(--card); box-shadow:0 10px 28px var(--shadow); display:grid; grid-template-rows:auto auto 1fr}
    .panel.astrology .panel-top{background:linear-gradient(135deg,var(--astro1),var(--astro2))}
    .panel.tarot .panel-top{background:linear-gradient(135deg,var(--tarot1),var(--tarot2))}
    .panel-top{color:#fff; padding:16px; display:flex; align-items:center; justify-content:space-between}
    .panel-top h2{margin:0; font-size:1.1rem; letter-spacing:.4px}
    .tabs{display:flex; gap:8px; padding:12px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)); overflow:auto}
    .tab-btn{appearance:none; border:1px solid var(--line); background:var(--card); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; position:relative}
    .tab-btn[data-accent="astro"]{border-color:rgba(122,162,255,.5)}
    .tab-btn[data-accent="tarot"]{border-color:rgba(111,200,255,.6)}
    .tab-btn[aria-selected="true"]{box-shadow:var(--focus)}
    .tab-btn[aria-selected="true"]::after{content:""; position:absolute; left:10px; right:10px; bottom:-7px; height:3px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); border-radius:999px}
    .panel-body{padding:14px}
    .callout{border:1px dashed var(--line); border-radius:12px; padding:14px; color:var(--muted); font-size:.95rem}
    .callout strong{color:var(--text)}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
    .badge{display:inline-block; font-size:.78rem; padding:3px 8px; border:1px solid var(--line); border-radius:999px; margin-right:6px}
    .blurb{font-size:.95rem; color:var(--muted); margin-top:6px}
    .row{display:flex; justify-content:space-between; gap:12px; align-items:center}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{border:1px solid var(--line); border-radius:14px; padding:14px; background:var(--card)}
    .glyph{font-size:1.35rem; width:1.6rem}
    .tag{font-size:.88rem; color:var(--muted)}
    .seg{display:inline-grid; grid-auto-flow:column; border:1px solid var(--line); border-radius:12px; overflow:hidden}
    .seg button{background:var(--card); color:var(--text); padding:8px 12px; border:0; border-right:1px solid var(--line); cursor:pointer; font-weight:700}
    .seg button:last-child{border-right:0}
    .seg button[aria-pressed="true"]{background:var(--infoBG); box-shadow:var(--focus)}
    .info-box{border:1px solid var(--line); background:var(--infoBG); border-radius:12px; padding:12px; color:var(--muted); margin-bottom:8px}
    .info-box strong{color:var(--text)}
    .hilite{box-shadow:0 0 0 3px rgba(122,162,255,.35) inset, 0 0 0 1px rgba(122,162,255,.6); border-color:rgba(122,162,255,.6)}

    .page{position:fixed; inset:0; background:var(--bg); display:none; z-index:60}
    .page.show{display:block}
    .page-inner{max-width:1000px; margin:0 auto; padding:16px 16px 96px; display:grid; gap:16px}
    .page-head{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .back{appearance:none; background:var(--button); color:var(--button-text); border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800}
    .page-title{font-size:1.25rem; margin:0; letter-spacing:.3px; font-weight:900; background:linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; background-clip:text; color:transparent}

    footer{border-top:1px solid var(--line); background:linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
    .belt{max-width:1200px; margin:0 auto; padding:10px 16px 14px; display:grid; gap:10px}
    .belt h3{margin:6px 0 4px; font-size:.95rem; color:var(--muted)}
    .orbit{display:grid; grid-auto-flow:column; grid-auto-columns:minmax(56px,1fr); gap:8px; align-items:stretch; overflow:auto; padding-bottom:6px}
    .orb{position:relative; border:1px solid var(--line); background:var(--card); border-radius:12px; display:flex; align-items:center; justify-content:center; padding:10px; cursor:default; min-height:52px}
    .orb .sym{font-size:1.15rem}
    .tip{position:absolute; bottom:110%; left:50%; transform:translateX(-50%) translateY(6px); background:var(--card); border:1px solid var(--line); color:var(--text); padding:10px 12px; border-radius:10px; min-width:200px; box-shadow:0 10px 20px var(--shadow); pointer-events:none; opacity:0; transition:opacity .15s, transform .15s; font-size:.85rem; line-height:1.35}
    .orb:hover .tip{opacity:1; transform:translateX(-50%) translateY(0)}
    .tip .label{font-weight:800}
    .tip .mini{color:var(--muted); font-size:.8rem}

    .chat-launch{position:fixed; right:16px; bottom:16px; z-index:70; background:var(--button); color:var(--button-text); border:1px solid var(--line); padding:10px 12px; border-radius:999px; font-weight:800; cursor:pointer; box-shadow:0 8px 20px var(--shadow)}
    .chat{position:fixed; right:16px; bottom:16px; width:min(420px, calc(100vw - 32px)); z-index:75; display:none; border:1px solid var(--line); border-radius:16px; background:var(--card); box-shadow:0 18px 36px var(--shadow); overflow:hidden}
    .chat.show{display:grid; grid-template-rows:auto 1fr auto}
    .chat-head{background:linear-gradient(135deg,var(--astro1),var(--tarot2)); color:#fff; padding:12px 14px; display:flex; justify-content:space-between; align-items:center}
    .chat-body{padding:12px; display:grid; gap:10px; max-height:45vh; overflow:auto}
    .msg{border:1px solid var(--line); background:var(--bg); border-radius:12px; padding:10px 12px; font-size:.95rem}
    .msg.user{background:var(--infoBG)}
    .chat-foot{display:flex; gap:8px; padding:10px; border-top:1px solid var(--line); background:var(--card)}
    .chat-foot input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--bg); color:var(--text)}
    .chat-foot button{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--button); color:var(--button-text); font-weight:800; cursor:pointer}

    @media (max-width:900px){.main{grid-template-columns:1fr}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}.head-inner{flex-wrap:wrap; gap:8px}.hint{display:none}}
  </style>
</head>
<body data-theme="dark">
  <a href="#main" class="visually-hidden">Skip to content</a>
  <div class="wrap" id="main">
    <header>
      <div class="head-inner">
        <div class="brand" aria-label="Starborn brand">
          <div class="brand-badge" aria-hidden="true"></div>
          <div>
            <div style="font-weight:900; font-size:1.05rem; letter-spacing:.4px">Starborn Astrology & Tarot</div>
            <div class="hint">Chill & vibrant astro–tarot portal with live astronomy tidbits.</div>
          </div>
        </div>
        <div class="spacer"></div>
        <button class="toggle" id="themeToggle" aria-label="Toggle black/white theme">
          <span>Theme</span><strong id="themeLabel">Black</strong>
        </button>
      </div>
    </header>

    <main class="main" aria-live="polite">
      <section class="panel astrology" aria-label="Astrology panel">
        <div class="panel-top">
          <h2>Astrology</h2>
          <div class="hint">Tropical • Placidus</div>
        </div>
        <div class="tabs" role="tablist" aria-label="Astrology tabs">
          <button class="tab-btn" data-accent="astro" data-route="signs" role="tab" aria-selected="false">Signs</button>
          <button class="tab-btn" data-accent="astro" data-route="planets" role="tab" aria-selected="false">Planets</button>
        </div>
        <div class="panel-body">
          <div class="callout">
            <strong>Browse:</strong> Signs and Planets. On Planets, toggle <em>Astrology</em>/<em>Astronomy</em>; Astronomy notes show at the top.
          </div>
        </div>
      </section>

      <section class="panel tarot" aria-label="Tarot panel">
        <div class="panel-top">
          <h2>Tarot</h2>
          <div class="hint">Rider–Waite deck</div>
        </div>
        <div class="tabs" role="tablist" aria-label="Tarot tabs">
          <button class="tab-btn" data-accent="tarot" data-route="major" role="tab" aria-selected="false">Great Arcana</button>
          <button class="tab-btn" data-accent="tarot" data-route="minor" role="tab" aria-selected="false">Small Arcana</button>
        </div>
        <div class="panel-body">
          <div class="callout">
            <strong>Study:</strong> Major Arcana with upright/reversed keywords, and Minor with card-level keywords.
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="belt">
        <h3>Astronomy • hover a body for quick facts</h3>
        <div class="orbit" id="orbit"></div>
      </div>
    </footer>
  </div>

  <div class="page" id="page" aria-modal="true" role="dialog" aria-labelledby="pageTitle">
    <div class="page-inner">
      <div class="page-head">
        <button class="back" id="backBtn" aria-label="Go back">← Back</button>
        <h1 class="page-title" id="pageTitle">Page</h1>
      </div>
      <div id="pageContent"></div>
    </div>
  </div>

  <!-- Chat -->
  <button class="chat-launch" id="chatOpen" aria-controls="chatBox" aria-expanded="false">Ask Starborn</button>
  <div class="chat" id="chatBox" role="dialog" aria-labelledby="chatTitle" aria-modal="true">
    <div class="chat-head">
      <strong id="chatTitle">Starborn Helper</strong>
      <button class="back" id="chatClose" aria-label="Close chat">×</button>
    </div>
    <div class="chat-body" id="chatBody" aria-live="polite"></div>
    <div class="chat-foot">
      <input id="chatInput" type="text" placeholder="Ask about Aries, mutable signs, Three of Swords, Mars orbit…" />
      <button id="chatSend">Send</button>
    </div>
  </div>

  <script>
    /* ===================== DATA ===================== */
    const SIGNS = [
      {name:"Aries", glyph:"\u2648", element:"Fire", modality:"Cardinal", polarity:"Yang", ruler:"Mars", blurb:"Initiation, courage, heat-first action."},
      {name:"Taurus", glyph:""\u2649", element:"Earth", modality:"Fixed", polarity:"Yin", ruler:"Venus", blurb:"Stability, senses, slow-and-steady growth."},
      {name:"Gemini", glyph:"\u264A", element:"Air", modality:"Mutable", polarity:"Yang", ruler:"Mercury", blurb:"Curiosity, dialogue, quick connections."},
      {name:"Cancer", glyph:"\u264B", element:"Water", modality:"Cardinal", polarity:"Yin", ruler:"Moon", blurb:"Nurture, memory, protective home-base."},
      {name:"Leo", glyph:"\u264C", element:"Fire", modality:"Fixed", polarity:"Yang", ruler:"Sun", blurb:"Heart, creative radiance, stage presence."},
      {name:"Virgo", glyph:"\u264D", element:"Earth", modality:"Mutable", polarity:"Yin", ruler:"Mercury", blurb:"Refinement, service, craft and clarity."},
      {name:"Libra", glyph:"\u264E", element:"Air", modality:"Cardinal", polarity:"Yang", ruler:"Venus", blurb:"Relating, balance, aesthetic judgment."},
      {name:"Scorpio", glyph:"\u264F", element:"Water", modality:"Fixed", polarity:"Yin", ruler:"Mars/Pluto", blurb:"Depth, bonds, strategic transformation."},
      {name:"Sagittarius", glyph:"\u2650", element:"Fire", modality:"Mutable", polarity:"Yang", ruler:"Jupiter", blurb:"Quest, philosophy, long-view optimism."},
      {name:"Capricorn", glyph:"\u2651", element:"Earth", modality:"Cardinal", polarity:"Yin", ruler:"Saturn", blurb:"Structure, mastery, long-term building."},
      {name:"Aquarius", glyph:"\u2652", element:"Air", modality:"Fixed", polarity:"Yang", ruler:"Saturn/Uranus", blurb:"Systems, networks, principled originality."},
      {name:"Pisces", glyph:"\u2653", element:"Water", modality:"Mutable", polarity:"Yin", ruler:"Jupiter/Neptune", blurb:"Imagination, empathy, dissolving boundaries."},
    ];

    const PLANETS = [
      {name:"Sun", glyph:"\u2609", rot:"~25 d (equator)", orb:"365.25 d (Earth frame)"},
      {name:"Moon", glyph:"\u263D", rot:"27.32 d (tidal lock)", orb:"27.32 d (around Earth)"},
      {name:"Mercury", glyph:"\u263F", rot:"58.6 d", orb:"88 d"},
      {name:"Venus", glyph:"\u2640", rot:"-243 d (retrograde)", orb:"225 d"},
      {name:"Mars", glyph:"\u2642", rot:"24.6 h", orb:"687 d"},
      {name:"Jupiter", glyph:"\u2643", rot:"9.9 h", orb:"11.86 y"},
      {name:"Saturn", glyph:"\u2644", rot:"10.7 h", orb:"29.46 y"},
      {name:"Uranus", glyph:"\u2645", rot:"-17.2 h (retrograde tilt)", orb:"84 y"},
      {name:"Neptune", glyph:"\u2646", rot:"16.1 h", orb:"164.8 y"},
      {name:"Pluto", glyph:"\u2647", rot:"6.39 d", orb:"248 y"},
    ];

    const PLANET_ASTRO = {
      Sun:       {keywords:["Vitality","Ego","Purpose"], rules:["Leo"], modern:[], dignities:"Ruler Leo"},
      Moon:      {keywords:["Emotions","Memory","Needs"], rules:["Cancer"], modern:[], dignities:"Ruler Cancer"},
      Mercury:   {keywords:["Mind","Speech","Trade"], rules:["Gemini","Virgo"], modern:[], dignities:"Ruler Gemini/Virgo"},
      Venus:     {keywords:["Love","Attraction","Values"], rules:["Taurus","Libra"], modern:[], dignities:"Ruler Taurus/Libra"},
      Mars:      {keywords:["Action","Drive","Conflict"], rules:["Aries","Scorpio*"], modern:["Pluto (modern)"], dignities:"Ruler Aries; co-rules Scorpio"},
      Jupiter:   {keywords:["Growth","Belief","Fortune"], rules:["Sagittarius","Pisces*"], modern:["Neptune (modern)"], dignities:"Ruler Sagittarius; co-rules Pisces"},
      Saturn:    {keywords:["Structure","Limits","Time"], rules:["Capricorn","Aquarius*"], modern:["Uranus (modern)"], dignities:"Ruler Capricorn; co-rules Aquarius"},
      Uranus:    {keywords:["Innovation","Shock","Liberation"], rules:[], modern:["Aquarius"], dignities:"Modern ruler Aquarius"},
      Neptune:   {keywords:["Dreams","Mystic","Dissolution"], rules:[], modern:["Pisces"], dignities:"Modern ruler Pisces"},
      Pluto:     {keywords:["Power","Depth","Transformation"], rules:[], modern:["Scorpio"], dignities:"Modern ruler Scorpio"}
    };

    const MAJOR = [
      {name:"0 The Fool", up:["Beginnings","Trust"], rev:["Reckless","Naïveté"]},
      {name:"I The Magician", up:["Will","Skill"], rev:["Trickery","Misuse"]},
      {name:"II The High Priestess", up:["Intuition","Mystery"], rev:["Secrets","Disconnection"]},
      {name:"III The Empress", up:["Fertility","Care"], rev:["Smothering","Block"]},
      {name:"IV The Emperor", up:["Order","Authority"], rev:["Rigidity","Control"]},
      {name:"V The Hierophant", up:["Tradition","Doctrine"], rev:["Dogma","Rebellion"]},
      {name:"VI The Lovers", up:["Union","Choice"], rev:["Misalignment","Indecision"]},
      {name:"VII The Chariot", up:["Drive","Victory"], rev:["Force","Scatter"]},
      {name:"VIII Strength", up:["Courage","Compassion"], rev:["Doubt","Impatience"]},
      {name:"IX The Hermit", up:["Search","Wisdom"], rev:["Isolation","Withdrawal"]},
      {name:"X Wheel of Fortune", up:["Cycles","Chance"], rev:["Stagnation","Resist"]},
      {name:"XI Justice", up:["Balance","Truth"], rev:["Bias","Injustice"]},
      {name:"XII The Hanged Man", up:["Surrender","Reframe"], rev:["Stuck","Martyr"]},
      {name:"XIII Death", up:["Endings","Rebirth"], rev:["Clinging","Delay"]},
      {name:"XIV Temperance", up:["Blend","Equilibrium"], rev:["Excess","Imbalance"]},
      {name:"XV The Devil", up:["Bondage","Attachment"], rev:["Release","Awareness"]},
      {name:"XVI The Tower", up:["Upheaval","Revelation"], rev:["Avoidance","Aftershock"]},
      {name:"XVII The Star", up:["Hope","Healing"], rev:["Doubt","Drained"]},
      {name:"XVIII The Moon", up:["Dreams","Unseen"], rev:["Confusion","Fear"]},
      {name:"XIX The Sun", up:["Vitality","Joy"], rev:["Ego","Clouded"]},
      {name:"XX Judgement", up:["Awakening","Calling"], rev:["Guilt","Delay"]},
      {name:"XXI The World", up:["Completion","Integration"], rev:["Loose ends","Travel block"]},
    ];

    const RANKS = ["Ace","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Page","Knight","Queen","King"];
    const MINOR_KEYWORDS = {/* ...same as previous message... */};
    const MINOR_REVERSED = {/* ...same as previous message... */};

    /* ===================== THEME ===================== */
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    function applyTheme(t){ document.body.setAttribute('data-theme', t); themeLabel.textContent = (t==='dark')?'Black':'White'; try{localStorage.setItem('starborn-theme', t);}catch{} }
    (function(){ let t='dark'; try{const s=localStorage.getItem('starborn-theme'); if(s==='light'||s==='dark') t=s; else if(matchMedia('(prefers-color-scheme: light)').matches) t='light';}catch{} applyTheme(t);})();
    themeToggle.addEventListener('click', ()=>{ const cur=document.body.getAttribute('data-theme'); applyTheme(cur==='dark'?'light':'dark'); });

    /* ===================== ROUTER + DEEPLINKS ===================== */
    const page = document.getElementById('page');
    const pageTitle = document.getElementById('pageTitle');
    const pageContent = document.getElementById('pageContent');
    const backBtn = document.getElementById('backBtn');
    function lockScroll(yes){ document.documentElement.style.overflow = yes?'hidden':''; document.body.style.overflow = yes?'hidden':''; }

    function parseHash(){
      // e.g. #/planets/Mars?mode=astronomy
      const raw = location.hash.replace(/^#\/?/, '');
      const [path, qs=''] = raw.split('?');
      const parts = path.split('/').filter(Boolean);
      const q = new URLSearchParams(qs);
      return { raw, parts, q };
    }

    function openPageFromHash(){
      const {parts, q} = parseHash();
      if(parts.length===0){ page.classList.remove('show'); lockScroll(false); return; }
      const key = parts[0];
      const extras = parts.slice(1);
      openPage(key, { extras, q });
    }

    function openPage(key, routeState={}){
      pageContent.innerHTML = '';
      let title = 'Page';
      if(key==='signs'){ title='Zodiac Signs'; renderSigns(); }
      else if(key==='planets'){ title='Planets'; renderPlanets(routeState); }
      else if(key==='major'){ title='Tarot — Great Arcana (Rider–Waite)'; renderMajor(routeState); }
      else if(key==='minor'){ title='Tarot — Small Arcana'; renderMinor(routeState); }
      pageTitle.textContent = title;
      page.classList.add('show'); lockScroll(true); backBtn.focus();
    }

    function closePage(){ page.classList.remove('show'); lockScroll(false); history.pushState('', document.title, location.pathname+location.search); const last=document.querySelector('.tab-btn[aria-selected="true"]'); if(last) last.focus(); }
    backBtn.addEventListener('click', closePage);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape' && page.classList.contains('show')) closePage(); });

    document.querySelectorAll('.tab-btn').forEach((btn,i,all)=>{
      btn.addEventListener('click', ()=>{ all.forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true'); location.hash='#/'+btn.getAttribute('data-route'); });
      btn.addEventListener('keydown', e=>{ if(e.key==='ArrowRight') (all[i+1]||all[0]).focus(); if(e.key==='ArrowLeft') (all[i-1]||all[all.length-1]).focus(); });
    });

    window.addEventListener('hashchange', openPageFromHash);
    if(location.hash.replace(/^#\/?/,'')) openPageFromHash();

    /* ===================== RENDERERS ===================== */
    function renderSigns(){
      const tools=document.createElement('div'); tools.className='toolbar';
      const selElem=document.createElement('select'); ["All Elements","Fire","Earth","Air","Water"].forEach(v=>{const o=document.createElement('option');o.value=v.replace('All ','').toLowerCase();o.textContent=v;selElem.appendChild(o);});
      const selMod=document.createElement('select'); ["All Modalities","Cardinal","Fixed","Mutable"].forEach(v=>{const o=document.createElement('option');o.value=v.replace('All ','').toLowerCase();o.textContent=v;selMod.appendChild(o);});
      const search=document.createElement('input'); search.type='search'; search.placeholder='Search name (e.g., “Leo”)';
      const clearBtn=document.createElement('button'); clearBtn.className='toggle'; clearBtn.textContent='Clear';
      const info=document.createElement('div'); info.className='tag'; info.style.marginLeft='auto';
      tools.append(selElem, selMod, search, clearBtn, info);

      const grid=document.createElement('div'); grid.className='grid';
      function match(s){ const e=selElem.value, m=selMod.value, q=search.value.trim().toLowerCase(); let ok=true; if(["fire","earth","air","water"].includes(e)) ok &= s.element.toLowerCase()===e; if(["cardinal","fixed","mutable"].includes(m)) ok &= s.modality.toLowerCase()===m; if(q) ok &= s.name.toLowerCase().includes(q); return ok; }
      function draw(){ grid.innerHTML=''; const items=SIGNS.filter(match); info.textContent=`${items.length} / 12 shown`; items.forEach(s=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="row"><div><strong>${s.name}</strong></div><div class="glyph" aria-hidden="true">${s.glyph}</div></div><div class="tag"><span class="badge">${s.element}</span><span class="badge">${s.modality}</span><span class="badge">${s.polarity}</span><span class="badge">Ruler: ${s.ruler}</span></div><div class="blurb">${s.blurb}</div>`; grid.appendChild(el); });}
      selElem.addEventListener('change',draw); selMod.addEventListener('change',draw); search.addEventListener('input',draw); clearBtn.addEventListener('click',()=>{selElem.value='elements';selMod.value='modalities';search.value='';draw();});
      pageContent.append(tools, grid); draw();
    }

    function renderPlanets(routeState){
      const tools=document.createElement('div'); tools.className='toolbar';
      const seg=document.createElement('div'); seg.className='seg'; seg.innerHTML=`<button id="modeAstro" aria-pressed="true">Astrology</button><button id="modeAstr" aria-pressed="false">Astronomy</button>`;
      tools.appendChild(seg);

      const notes=document.createElement('div'); notes.className='info-box';
      notes.innerHTML=`<strong>Astronomy notes:</strong> rotation = length of the body's day; orbit period = time to complete one revolution around its primary. Earth “year” under Sun is Earth-frame.`;

      const gridAstro=document.createElement('div'); gridAstro.className='grid';
      const gridAstr=document.createElement('div'); gridAstr.className='grid'; gridAstr.style.display='none';

      PLANETS.forEach(p=>{
        const meta=PLANET_ASTRO[p.name]||{keywords:[],rules:[],modern:[],dignities:""};
        const el=document.createElement('div'); el.className='card'; el.id=`planet-${p.name.toLowerCase()}`;
        el.innerHTML=`<div class="row"><div><strong>${p.name}</strong></div><div class="glyph" aria-hidden="true">${p.glyph}</div></div>
          <div class="tag"><span class="badge">Keywords</span> ${meta.keywords.join(' • ')}</div>
          <div class="tag"><span class="badge">Traditional</span> ${meta.rules.length?meta.rules.join(' / '):'—'}</div>
          <div class="tag"><span class="badge">Modern</span> ${meta.modern.length?meta.modern.join(' / '):'—'}</div>
          <div class="blurb">${meta.dignities}</div>`;
        gridAstro.appendChild(el);
      });

      PLANETS.forEach(p=>{
        const el=document.createElement('div'); el.className='card'; el.id=`planet-astr-${p.name.toLowerCase()}`;
        el.innerHTML=`<div class="row"><div><strong>${p.name}</strong></div><div class="glyph" aria-hidden="true">${p.glyph}</div></div>
          <div class="tag">Rotation: ${p.rot}</div>
          <div class="tag">Orbit period: ${p.orb}</div>`;
        gridAstr.appendChild(el);
      });

      pageContent.append(notes, tools, gridAstro, gridAstr);

      const btnAstro=tools.querySelector('#modeAstro');
      const btnAstr=tools.querySelector('#modeAstr');
      function setMode(mode){
        const astroOn=mode==='astro';
        btnAstro.setAttribute('aria-pressed', astroOn?'true':'false');
        btnAstr.setAttribute('aria-pressed', astroOn?'false':'true');
        gridAstro.style.display=astroOn?'grid':'none';
        gridAstr.style.display=astroOn?'none':'grid';
        notes.style.display=astroOn?'none':'block';
      }
      btnAstro.addEventListener('click',()=>setMode('astro'));
      btnAstr.addEventListener('click',()=>setMode('astr'));

      // Apply deeplink: ?mode=astronomy and /<PlanetName>
      const planetName = (routeState.extras?.[0]||'').toLowerCase();
      const modeParam = (routeState.q?.get('mode')||'').toLowerCase();
      if(modeParam==='astronomy') setMode('astr'); else setMode('astro');

      if(planetName){
        const id = (modeParam==='astronomy') ? `planet-astr-${planetName}` : `planet-${planetName}`;
        const target = document.getElementById(id);
        if(target){ target.classList.add('hilite'); target.scrollIntoView({block:'center'}); setTimeout(()=>target.classList.remove('hilite'), 2000); }
      }
    }

    function renderMajor(routeState){
      const tools=document.createElement('div'); tools.className='toolbar';
      const sw=document.createElement('div'); sw.className='seg';
      sw.innerHTML=`<button id="uprBtn" aria-pressed="true">Upright</button><button id="revBtn" aria-pressed="false">Reversed</button>`;
      tools.appendChild(sw);

      const grid=document.createElement('div'); grid.className='grid';
      const romanId = routeState.extras?.[0] || '';
      const romanMap = {}; // map roman -> element
      MAJOR.forEach(card=>{
        const roman = card.name.split(' ')[0]; // e.g. 'XIII'
        const el=document.createElement('div'); el.className='card'; el.id=`major-${roman}`;
        el.innerHTML=`<div class="row"><div><strong>${card.name}</strong></div></div>
          <div class="tag up"><span class="badge">Upright</span> ${card.up.join(' • ')}</div>
          <div class="tag rev" style="display:none;"><span class="badge">Reversed</span> ${card.rev.join(' • ')}</div>`;
        romanMap[roman]=el;
        grid.appendChild(el);
      });

      pageContent.append(tools, grid);

      const upr=tools.querySelector('#uprBtn'); const rev=tools.querySelector('#revBtn');
      function setMode(mode){ upr.setAttribute('aria-pressed', mode==='up'); rev.setAttribute('aria-pressed', mode==='rev'); grid.querySelectorAll('.up').forEach(n=>n.style.display=mode==='up'?'block':'none'); grid.querySelectorAll('.rev').forEach(n=>n.style.display=mode==='rev'?'block':'none'); }
      upr.addEventListener('click',()=>setMode('up')); rev.addEventListener('click',()=>setMode('rev'));

      // Deeplink: highlight target card by roman
      if(romanId && romanMap[romanId]){ const t=romanMap[romanId]; t.classList.add('hilite'); t.scrollIntoView({block:'center'}); setTimeout(()=>t.classList.remove('hilite'),2000); }
    }

    function renderMinor(routeState){
      const wrap=document.createElement('div'); wrap.className='grid';
      const wantSuit = (routeState.extras?.[0]||'').toLowerCase(); // e.g. 'swords'
      const wantRank = (routeState.extras?.[1]||'').toLowerCase(); // e.g. 'three'

      Object.entries(MINOR_KEYWORDS).forEach(([suit, map])=>{
        const el=document.createElement('div'); el.className='card';
        const details=document.createElement('details'); details.open=false; details.id=`minor-${suit.toLowerCase()}`;
        const summary=document.createElement('summary'); summary.innerHTML=`<strong>${suit}</strong> <span class="tag">14 cards • upright/reversed</span>`;
        details.appendChild(summary);

        const list=document.createElement('div'); list.style.marginTop='8px'; list.style.display='grid'; list.style.gap='8px';
        RANKS.forEach(rank=>{
          const up=map[rank]; const rev=MINOR_REVERSED[suit][rank];
          const rid = `minor-${suit.toLowerCase()}-${rank.toLowerCase()}`;
          const row=document.createElement('div'); row.className='row'; row.style.alignItems='start'; row.id=rid;
          row.innerHTML=`<div><strong>${rank}</strong></div>
            <div class="tag" style="text-align:right">
              <div><span class="badge">Upright</span> ${up[0]} • ${up[1]}</div>
              <div><span class="badge">Reversed</span> ${rev[0]} • ${rev[1]}</div>
            </div>`;
          list.appendChild(row);
        });
        details.appendChild(list); el.appendChild(details); wrap.appendChild(el);
      });

      pageContent.appendChild(wrap);

      // Deeplink behavior
      if(wantSuit){
        const d = document.getElementById(`minor-${wantSuit}`);
        if(d){ d.open = true; }
        if(wantRank){
          const r = document.getElementById(`minor-${wantSuit}-${wantRank}`);
          if(r){ r.classList.add('hilite'); r.scrollIntoView({block:'center'}); setTimeout(()=>r.classList.remove('hilite'),2000); }
        } else if (d){ d.scrollIntoView({block:'start'}); }
      }
    }

    /* ===================== ASTRONOMY BELT ===================== */
    const orbit=document.getElementById('orbit');
    const BELT_ORDER=[{name:"Sun",sym:"\u2609"},{name:"Mercury",sym:"\u263F"},{name:"Venus",sym:"\u2640"},{name:"Earth",sym:"\u2295"},{name:"Moon",sym:"\u263D"},{name:"Mars",sym:"\u2642"},{name:"Jupiter",sym:"\u2643"},{name:"Saturn",sym:"\u2644"},{name:"Uranus",sym:"\u2645"},{name:"Neptune",sym:"\u2646"},{name:"Pluto",sym:"\u2647"}];
    const FACTS=Object.fromEntries(PLANETS.map(p=>[p.name,{rot:p.rot,orb:p.orb}])); FACTS["Earth"]={rot:"23h 56m (sidereal)",orb:"365.25 d"};
    BELT_ORDER.forEach(b=>{ const node=document.createElement('div'); node.className='orb'; node.setAttribute('aria-label', b.name); node.innerHTML=`<div class="sym" aria-hidden="true">${b.sym}</div><div class="tip" role="tooltip"><div class="label">${b.name}</div><div class="mini">Rotation: ${FACTS[b.name]?.rot??"—"}</div><div class="mini">Orbit: ${FACTS[b.name]?.orb??"—"}</div></div>`; orbit.appendChild(node); });

    /* ===================== CHAT (LOCAL QA) ===================== */
    const chatOpen=document.getElementById('chatOpen'), chatBox=document.getElementById('chatBox'), chatClose=document.getElementById('chatClose'), chatBody=document.getElementById('chatBody'), chatInput=document.getElementById('chatInput'), chatSend=document.getElementById('chatSend');
    function showChat(show){ chatBox.classList.toggle('show', show); chatOpen.setAttribute('aria-expanded', show?'true':'false'); if(show) chatInput.focus(); }
    chatOpen.addEventListener('click',()=>showChat(true)); chatClose.addEventListener('click',()=>showChat(false));
    function addMsg(text, who='bot'){ const div=document.createElement('div'); div.className='msg '+(who==='user'?'user':'bot'); div.textContent=text; chatBody.appendChild(div); chatBody.scrollTop=chatBody.scrollHeight; }
    function handleAsk(q){ addMsg(answerFromLocal(q),'bot'); }
    chatSend.addEventListener('click',()=>{ const q=chatInput.value.trim(); if(!q) return; addMsg(q,'user'); chatInput.value=''; handleAsk(q); });
    chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter') chatSend.click(); });

    function normalize(s){ return s.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); }
    const majorIndex=Object.fromEntries(MAJOR.map(m=>[normalize(m.name), m]));
    const minorIndex={}; Object.keys(MINOR_KEYWORDS).forEach(suit=>{ RANKS.forEach(rank=>{ const k=normalize(`${rank} of ${suit}`); minorIndex[k]={suit,rank,up:MINOR_KEYWORDS[suit][rank],rev:MINOR_REVERSED[suit][rank]}; }); });

    function answerFromLocal(q){
      const query=normalize(q);
      for(const s of SIGNS){ if(query.includes(normalize(s.name))) return `${s.name} — ${s.element} ${s.modality} (${s.polarity}). Ruler: ${s.ruler}. ${s.blurb}`; }
      if(/water|fire|earth|air/.test(query)){ const el= query.match(/water|fire|earth|air/)[0]; const cap=el[0].toUpperCase()+el.slice(1); const list=SIGNS.filter(s=>s.element===cap).map(s=>s.name).join(', '); return `${cap} signs: ${list}.`; }
      if(/cardinal|fixed|mutable/.test(query)){ const m=query.match(/cardinal|fixed|mutable/)[0]; const cap=m[0].toUpperCase()+m.slice(1); const list=SIGNS.filter(s=>s.modality===cap).map(s=>s.name).join(', '); return `${cap} signs: ${list}.`; }

      for(const p of PLANETS){
        const nm=normalize(p.name);
        if(query.includes(nm)){
          const meta=PLANET_ASTRO[p.name];
          if(/rotation|rotates|day/.test(query)) return `${p.name} rotation: ${p.rot}.`;
          if(/orbit|year|period/.test(query)) return `${p.name} orbital period: ${p.orb}.`;
          if(meta) return `${p.name} (astrology): ${meta.keywords.join(', ')}. Traditional: ${meta.rules.join('/')} ${meta.modern.length?'; modern: '+meta.modern.join('/'):''}.`;
          return `${p.name} — Rotation: ${p.rot}. Orbit: ${p.orb}.`;
        }
      }

      for(const m of MAJOR){ if(query.includes(normalize(m.name))) return /(rev|reversed)/.test(query)? `${m.name} (reversed): ${m.rev.join(', ')}.` : `${m.name} (upright): ${m.up.join(', ')}.`; }

      const mi=Object.keys(minorIndex).find(k=>query.includes(k));
      if(mi){ const c=minorIndex[mi]; const wantRev=/(rev|reversed)/.test(query); const kws=wantRev?c.rev:c.up; return `${c.rank} of ${c.suit} (${wantRev?'reversed':'upright'}): ${kws[0]}, ${kws[1]}.`; }

      const anyRank=RANKS.find(r=>query.includes(normalize(r))); const anySuit=Object.keys(MINOR_KEYWORDS).find(su=>query.includes(normalize(su)));
      if(anyRank && anySuit){ const up=MINOR_KEYWORDS[anySuit][anyRank], rev=MINOR_REVERSED[anySuit][anyRank]; if(up&&rev){ const wantRev=/(rev|reversed)/.test(query); const kws=wantRev?rev:up; return `${anyRank} of ${anySuit} (${wantRev?'reversed':'upright'}): ${kws[0]}, ${kws[1]}.`; } }

      return "Try: “#/planets?mode=astronomy”, “#/planets/Mars”, “#/tarot/major/XIII”, or ask: “Mars rotation”, “mutable signs”, “Ace of Cups reversed”.";
    }
  </script>
</body>
</html>
